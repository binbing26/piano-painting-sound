<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>é’¢ç´å®¶çš„ç»˜ç”»å£°éŸ³è£…ç½® (iPadç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/p5.js"></script>
    <style>
        body { 
            margin: 0; 
            touch-action: none; /* ç¦ç”¨æµè§ˆå™¨é»˜è®¤è§¦æ‘¸è¡Œä¸º */
            background-color: #0a0f1e;
            overflow: hidden;
        }
        canvas { 
            display: block;
        }
        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(20, 25, 45, 0.8);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            gap: 15px;
            backdrop-filter: blur(5px);
        }
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            border: none;
            background-color: #3a4c80;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        .control-btn:hover, .control-btn:active {
            background-color: #5a70b3;
        }
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            font-family: "PingFang SC", "Helvetica Neue", sans-serif;
            background-color: rgba(20, 25, 45, 0.8);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            max-width: 250px;
        }
        #noteDisplay {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }
        .octave-marker {
            position: fixed;
            left: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-family: "PingFang SC", "Helvetica Neue", sans-serif;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
    </style>
</head>
<body>
    <div id="info">
        <div>éŸ³åŒº: <span id="octave">ä¸­éŸ³åŒº</span></div>
        <div>éŸ³ç¬¦: <span id="noteDisplay">C4</span></div>
        <div>åŠ›åº¦: <span id="pressure">ä¸­ç­‰</span></div>
    </div>
    
    <div class="octave-marker" style="top: 100px;">ä½éŸ³åŒº</div>
    <div class="octave-marker" style="top: 300px;">ä¸­éŸ³åŒº</div>
    <div class="octave-marker" style="top: 500px;">é«˜éŸ³åŒº</div>
    
    <div id="controls">
        <button class="control-btn" id="clearBtn">ğŸ—‘ï¸</button>
        <button class="control-btn" id="volumeUp">ğŸ”Š</button>
        <button class="control-btn" id="volumeDown">ğŸ”‡</button>
    </div>

    <script>
        // é’¢ç´å£°éŸ³è£…ç½® - iPadç½‘é¡µç‰ˆ
        // ä¸“ä¸ºé’¢ç´å®¶è®¾è®¡ï¼Œæ”¯æŒè§¦æ‘¸å±å’ŒApple Pencilå‹åŠ›æ„Ÿåº”
        
        let canvas;
        let trails = [];
        let audioContext;
        let pianoNotes = [];
        let volume = 0.7;
        let isDrawing = false;
        
        // é’¢ç´éŸ³é«˜æ˜ å°„ (Cå¤§è°ƒéŸ³é˜¶)
        const NOTE_FREQS = {
            'C2': 65.41, 'D2': 73.42, 'E2': 82.41, 'F2': 87.31, 'G2': 98.00, 'A2': 110.00, 'B2': 123.47,
            'C3': 130.81, 'D3': 146.83, 'E3': 164.81, 'F3': 174.61, 'G3': 196.00, 'A3': 220.00, 'B3': 246.94,
            'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88,
            'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, 'A5': 880.00, 'B5': 987.77,
            'C6': 1046.50, 'D6': 1174.66, 'E6': 1318.51, 'F6': 1396.91, 'G6': 1567.98, 'A6': 1760.00, 'B6': 1975.53
        };
        
        // é¢œè‰²ä¸»é¢˜ (é’¢ç´å®¶è§†è§’)
        const COLOR_THEME = {
            lowOctave: [60, 100, 200],   // ä½éŸ³åŒº - è“è‰²
            midOctave: [180, 80, 200],   // ä¸­éŸ³åŒº - ç´«è‰²
            highOctave: [220, 100, 120],  // é«˜éŸ³åŒº - ç²‰è‰²
            background: [10, 15, 30]     // èƒŒæ™¯è‰² - æ·±è‰²
        };
        
        function setup() {
            // åˆ›å»ºé€‚åˆiPadçš„ç”»å¸ƒ
            canvas = createCanvas(windowWidth, windowHeight);
            canvas.elt.addEventListener('touchmove', preventDefault, {passive: false});
            
            // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // é¢„ç”Ÿæˆé’¢ç´éŸ³è‰²
            generatePianoTones();
            
            // æŒ‰é’®äº‹ä»¶
            document.getElementById('clearBtn').addEventListener('click', clearCanvas);
            document.getElementById('volumeUp').addEventListener('click', () => {
                volume = min(volume + 0.1, 1.0);
            });
            document.getElementById('volumeDown').addEventListener('click', () => {
                volume = max(volume - 0.1, 0.2);
            });
        }
        
        function draw() {
            // ç»˜åˆ¶æ¸å˜èƒŒæ™¯
            backgroundGradient();
            
            // æ›´æ–°å¹¶ç»˜åˆ¶æ‰€æœ‰è½¨è¿¹
            for (let trail of trails) {
                trail.update();
                trail.draw();
            }
            
            // ç§»é™¤è¿‡æœŸè½¨è¿¹
            trails = trails.filter(trail => trail.isAlive());
        }
        
        // ç”Ÿæˆé’¢ç´éŸ³è‰² (æ¨¡æ‹Ÿä¸åŒéŸ³åŒºç‰¹æ€§)
        function generatePianoTones() {
            const notes = Object.keys(NOTE_FREQS);
            for (let note of notes) {
                const freq = NOTE_FREQS[note];
                pianoNotes[note] = {
                    freq: freq,
                    envelope: createEnvelope(),
                    oscillator: createOscillator(freq)
                };
            }
        }
        
        // åˆ›å»ºæŒ¯è¡å™¨ (æ¨¡æ‹Ÿé’¢ç´ä¸åŒéŸ³åŒºéŸ³è‰²)
        function createOscillator(freq) {
            let oscillator = audioContext.createOscillator();
            
            // æ ¹æ®é¢‘ç‡è°ƒæ•´æ³¢å½¢å’Œæ³›éŸ³ï¼Œæ¨¡æ‹Ÿé’¢ç´éŸ³è‰²
            if (freq < 200) { // ä½éŸ³åŒº - æ–¹å½¢æ³¢+æ³›éŸ³
                oscillator.type = 'square';
            } else if (freq < 800) { // ä¸­éŸ³åŒº - æ­£å¼¦æ³¢+å°‘é‡æ³›éŸ³
                oscillator.type = 'sine';
            } else { // é«˜éŸ³åŒº - æ­£å¼¦æ³¢
                oscillator.type = 'sine';
            }
            
            oscillator.frequency.value = freq;
            return oscillator;
        }
        
        // åˆ›å»ºåŒ…ç»œ (æ¨¡æ‹Ÿé’¢ç´éŸ³ç¬¦è¡°å‡)
        function createEnvelope() {
            let envelope = audioContext.createGain();
            
            // é’¢ç´éŸ³ç¬¦åŒ…ç»œ - å¿«é€Ÿè¡°å‡
            envelope.gain.setValueAtTime(0, audioContext.currentTime);
            
            return envelope;
        }
        
        // æ¼”å¥éŸ³ç¬¦ (æ”¯æŒå‹åŠ›æ„Ÿåº”)
        function playNote(noteName, pressure = 0.5) {
            if (!audioContext || !pianoNotes[noteName]) return;
            
            // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·² resume
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const note = pianoNotes[noteName];
            const now = audioContext.currentTime;
            
            // åˆ›å»ºæ–°çš„æŒ¯è¡å™¨ (Web AudioæŒ¯è¡å™¨åªèƒ½å¯åŠ¨ä¸€æ¬¡)
            const oscillator = createOscillator(note.freq);
            const envelope = createEnvelope();
            
            // è¿æ¥èŠ‚ç‚¹
            oscillator.connect(envelope);
            envelope.connect(audioContext.destination);
            
            // æ ¹æ®å‹åŠ›è®¾ç½®éŸ³é‡å’ŒåŒ…ç»œ
            const noteVolume = volume * pressure;
            
            // é’¢ç´åŒ…ç»œè®¾ç½®
            envelope.gain.setValueAtTime(0, now);
            envelope.gain.linearRampToValueAtTime(noteVolume, now + 0.02); // å¿«é€Ÿä¸Šå‡
            envelope.gain.linearRampToValueAtTime(noteVolume * 0.7, now + 0.1); // å¿«é€Ÿè¡°å‡
            envelope.gain.exponentialRampToValueAtTime(noteVolume * 0.01, now + 2.0); // ç¼“æ…¢é‡Šæ”¾
            
            // å¯åŠ¨æŒ¯è¡å™¨
            oscillator.start(now);
            oscillator.stop(now + 3.0); // 3ç§’ååœæ­¢
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('noteDisplay').textContent = noteName;
        }
        
        // æ ¹æ®Yä½ç½®ç¡®å®šéŸ³ç¬¦ (å±å¹•åº•éƒ¨=ä½éŸ³ï¼Œé¡¶éƒ¨=é«˜éŸ³)
        function getNoteByY(y) {
            const noteNames = Object.keys(NOTE_FREQS);
            const index = constrain(floor(map(y, height, 0, 0, noteNames.length-1)), 0, noteNames.length-1);
            return noteNames[index];
        }
        
        // æ ¹æ®Yä½ç½®ç¡®å®šéŸ³åŒº
        function getOctaveByY(y) {
            const octave = floor(map(y, height, 0, 2, 6)); // 2-6 octaves
            if (octave <= 3) return {name: "ä½éŸ³åŒº", color: COLOR_THEME.lowOctave};
            if (octave <= 5) return {name: "ä¸­éŸ³åŒº", color: COLOR_THEME.midOctave};
            return {name: "é«˜éŸ³åŒº", color: COLOR_THEME.highOctave};
        }
        
        // èƒŒæ™¯æ¸å˜
        function backgroundGradient() {
            for (let y = 0; y < height; y++) {
                const ratio = y / height;
                const r = COLOR_THEME.background[0] + ratio * 10;
                const g = COLOR_THEME.background[1] + ratio * 10;
                const b = COLOR_THEME.background[2] + ratio * 20;
                stroke(r, g, b);
                line(0, y, width, y);
            }
        }
        
        // è½¨è¿¹ç±» - æ”¯æŒå‹åŠ›æ„Ÿåº”
        class Trail {
            constructor(startX, startY, pressure) {
                this.points = [];
                this.addPoint(startX, startY, pressure);
                this.octave = getOctaveByY(startY);
                this.note = getNoteByY(startY);
                this.birthTime = millis();
                this.lifeSpan = 3000; // è½¨è¿¹ç”Ÿå‘½å‘¨æœŸ(æ¯«ç§’)
            }
            
            addPoint(x, y, pressure) {
                this.points.push({
                    x: x,
                    y: y,
                    pressure: pressure || 0.5,
                    timestamp: millis()
                });
                
                // æ¯éš”ä¸€å®šç‚¹æ•°æ’­æ”¾ä¸€ä¸ªéŸ³ç¬¦
                if (this.points.length % 5 === 0) {
                    this.note = getNoteByY(y);
                    this.octave = getOctaveByY(y);
                    playNote(this.note, pressure || 0.5);
                    
                    // æ›´æ–°éŸ³åŒºæ˜¾ç¤º
                    document.getElementById('octave').textContent = this.octave.name;
                    document.getElementById('pressure').textContent = 
                        pressure > 0.7 ? "å¼ºéŸ³(forte)" : 
                        pressure < 0.3 ? "å¼±éŸ³(piano)" : "ä¸­ç­‰(mezzo)";
                }
            }
            
            update() {
                // å¯ä»¥æ·»åŠ è½¨è¿¹åŠ¨ç”»æ•ˆæœ
            }
            
            draw() {
                if (this.points.length < 2) return;
                
                // è®¡ç®—è½¨è¿¹å¹´é¾„
                const age = millis() - this.birthTime;
                const alpha = map(age, 0, this.lifeSpan, 255, 0);
                
                // ç»˜åˆ¶è½¨è¿¹çº¿
                strokeWeight(2);
                beginShape();
                for (let i = 0; i < this.points.length; i++) {
                    const p = this.points[i];
                    const pointAge = millis() - p.timestamp;
                    const pointAlpha = map(pointAge, 0, 1500, alpha, 0);
                    
                    // æ ¹æ®å‹åŠ›è°ƒæ•´çº¿æ¡ç²—ç»†å’Œé¢œè‰²äº®åº¦
                    const weight = map(p.pressure, 0.2, 1.0, 2, 6);
                    const color = this.octave.color;
                    stroke(color[0], color[1], color[2], pointAlpha);
                    strokeWeight(weight);
                    vertex(p.x, p.y);
                    
                    // ç»˜åˆ¶é«˜å…‰æ•ˆæœ
                    stroke(color[0]+50, color[1]+50, color[2]+50, pointAlpha * 0.5);
                    strokeWeight(weight / 2);
                    vertex(p.x, p.y);
                }
                endShape();
            }
            
            isAlive() {
                return millis() - this.birthTime < this.lifeSpan;
            }
        }
        
        // è§¦æ‘¸å¼€å§‹ (å¼€å§‹ç»˜åˆ¶)
        function touchStarted(e) {
            e.preventDefault();
            isDrawing = true;
            
            // è·å–å‹åŠ›å€¼ (Apple Pencilæ”¯æŒ)
            const pressure = e.touches[0].force || 0.5;
            
            // åˆ›å»ºæ–°è½¨è¿¹
            const touch = e.touches[0];
            trails.push(new Trail(touch.clientX, touch.clientY, pressure));
            
            return false;
        }
        
        // è§¦æ‘¸ç§»åŠ¨ (ç»˜åˆ¶ä¸­)
        function touchMoved(e) {
            if (!isDrawing) return;
            
            e.preventDefault();
            const touch = e.touches[0];
            const pressure = e.touches[0].force || 0.5;
            
            // æ·»åŠ ç‚¹åˆ°æœ€æ–°è½¨è¿¹
            if (trails.length > 0) {
                trails[trails.length-1].addPoint(touch.clientX, touch.clientY, pressure);
            }
            
            return false;
        }
        
        // è§¦æ‘¸ç»“æŸ (åœæ­¢ç»˜åˆ¶)
        function touchEnded(e) {
            e.preventDefault();
            isDrawing = false;
            return false;
        }
        
        // èƒŒæ™¯æ¸å˜
        function backgroundGradient() {
            for (let y = 0; y < height; y++) {
                const ratio = y / height;
                const r = COLOR_THEME.background[0] + ratio * 5;
                const g = COLOR_THEME.background[1] + ratio * 5;
                const b = COLOR_THEME.background[2] + ratio * 15;
                stroke(r, g, b);
                line(0, y, width, y);
            }
        }
        
        // æ¸…é™¤ç”»å¸ƒ
        function clearCanvas() {
            trails = [];
        }
        
        // é˜²æ­¢é»˜è®¤è§¦æ‘¸è¡Œä¸º
        function preventDefault(e) {
            e.preventDefault();
        }
        
        // çª—å£å¤§å°è°ƒæ•´
        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }
    </script>
</body>
</html>